<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Отметка посещаемости</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="icon" href="{{ url_for('static', filename='favic.ico') }}">
    <style>
        /* Существующие стили остаются без изменений */
        .attendance-form { 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        .student-row { 
            transition: background-color 0.3s;
            border-left: 3px solid #d4edda;
        }
        .student-row:hover { 
            background-color: #f1f3f4;
            border-left: 3px solid #20c997;
        }
        .status-select {
            min-width: 180px;
        }
        .btn-present {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .btn-present:hover, .btn-present.active {
            background-color: #155724;
            color: white;
            border-color: #155724;
        }
        .btn-absent {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .btn-absent:hover, .btn-absent.active {
            background-color: #721c24;
            color: white;
            border-color: #721c24;
        }
        .btn-excused {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        .btn-excused:hover, .btn-excused.active {
            background-color: #856404;
            color: white;
            border-color: #856404;
        }
        .btn-late {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        .btn-late:hover, .btn-late.active {
            background-color: #0c5460;
            color: white;
            border-color: #0c5460;
        }
        .badge-status { 
            cursor: pointer; 
            transition: all 0.2s;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .badge-status:hover { 
            opacity: 0.8;
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Стили для боковой панели */
        body { background-color: #f8f9fa; }
        .sidebar-teacher {
            border-left: 4px solid #20c997;
        }
        .list-group-item.active {
            background-color: #198754 !important;
            border-color: #20533c !important;
        }
        .quick-actions-card .card-header {
            background: linear-gradient(135deg, #3c9958 0%, #0d663d 100%);
        }
        .quick-actions-card .btn-add-discipline {
            background-color: #20c997;
            border-color: #20c997;
            color: white;
        }
        .quick-actions-card .btn-add-discipline:hover {
            background-color: #17a589;
            border-color: #148f77;
        }
        .quick-actions-card .btn-mark-attendance {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }
        .quick-actions-card .btn-mark-attendance:hover {
            background-color: #157347;
            border-color: #146c43;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success shadow">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-mortarboard"></i> Учёт посещаемости
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-item nav-link text-white">
                    <i class="bi bi-person-circle"></i> {{ session['full_name'] }}
                </span>
                <a class="nav-item nav-link text-white" href="{{ url_for('logout') }}">
                    <i class="bi bi-box-arrow-right"></i> Выход
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Левое меню -->
            <div class="col-md-3">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-menu-button"></i> Меню преподавателя
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('dashboard') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-speedometer2"></i> Панель
                        </a>
                        <a href="{{ url_for('teacher_disciplines') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-book"></i> Мои дисциплины
                        </a>
                        <a href="{{ url_for('mark_attendance') }}" class="list-group-item list-group-item-action active">
                            <i class="bi bi-clipboard-check"></i> Отметка посещаемости
                        </a>
                        <a href="{{ url_for('teacher_statistics') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-bar-chart"></i> Статистика
                        </a>
                    </div>
                </div>

                <!-- Быстрые действия -->
                <div class="card quick-actions-card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-lightning"></i> Быстрые действия
                    </div>
                    <div class="card-body">
                        <a href="{{ url_for('add_discipline') }}" class="btn btn-add-discipline btn-sm w-100 mb-2">
                            <i class="bi bi-plus-circle"></i> Добавить дисциплину
                        </a>
                        <a href="{{ url_for('mark_attendance') }}" class="btn btn-mark-attendance btn-sm w-100">
                            <i class="bi bi-check-circle"></i> Отметить посещаемость
                        </a>
                    </div>
                </div>
            </div>

            <!-- Основной контент -->
            <div class="col-md-9">
                <h2><i class="bi bi-clipboard-check"></i> Отметка посещаемости</h2>
                <p class="text-muted">Дата: {{ today.strftime('%d.%m.%Y') }}</p>

                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        <div class="alert alert-success">
                            {% for message in messages %}
                                <div>{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                {% if not today_classes %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> На сегодня у вас нет занятий
                    </div>
                {% else %}
                    <div class="alert alert-primary">
                        <i class="bi bi-info-circle"></i> Выберите занятие для отметки посещаемости
                    </div>
                {% endif %}

                <!-- Выбор занятия -->
                <div class="row mb-4">
                    {% for class in today_classes %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">{{ class[1] }}</h5>
                                    <small>{{ class[2] }} | {{ class[3] }} | {{ class[4] }}</small>
                                </div>
                                <button class="btn btn-light btn-sm" onclick="loadClassStudents({{ class[0] }})">
                                    <i class="bi bi-people"></i> Отметить посещаемость
                                </button>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>Группа:</strong> {{ class[3] }}</p>
                                <p class="mb-1"><strong>Аудитория:</strong> {{ class[4] }}</p>
                                <p class="mb-0"><strong>Тип:</strong> {{ class[5] }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Форма для отметки посещаемости (скрыта по умолчанию) -->
                <div id="attendanceContainer" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0" id="className"></h4>
                            <small id="classDetails"></small>
                        </div>
                        <div class="card-body">
                            <form id="attendanceForm" method="POST">
                                <input type="hidden" name="schedule_id" id="scheduleId">
                                
                                <div id="studentsList" class="mb-4">
                                    <!-- Студенты будут загружены здесь динамически -->
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-save"></i> Сохранить все отметки
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                        <i class="bi bi-x-circle"></i> Отмена
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Существующий JavaScript остается без изменений -->
    <script>
        // Текущие данные о занятии и студентах
        let currentClassData = null;
        let attendanceData = {};

        // Загрузка студентов для выбранного занятия
        async function loadClassStudents(scheduleId) {
            try {
                const response = await fetch(`/teacher/attendance/class/${scheduleId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                currentClassData = data;
                attendanceData = {};
                
                // Отображаем информацию о занятии
                document.getElementById('className').textContent = data.class_info.name;
                document.getElementById('classDetails').innerHTML = 
                    `${data.class_info.date} | ${data.class_info.time} | ${data.class_info.group} | ${data.class_info.classroom}`;
                document.getElementById('scheduleId').value = data.class_info.id;
                
                // Очищаем и заполняем список студентов
                const studentsList = document.getElementById('studentsList');
                studentsList.innerHTML = '';
                
                if (data.students.length === 0) {
                    studentsList.innerHTML = '<div class="alert alert-warning">В группе нет студентов</div>';
                } else {
                    data.students.forEach((student, index) => {
                        const studentHtml = `
                            <div class="card mb-3 student-row">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <h6 class="mb-0">${student.name}</h6>
                                            <small class="text-muted">${student.login}</small>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="btn-group btn-group-sm" role="group">
                                                ${getStatusButtons(student.id, student.status)}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="text" 
                                                   class="form-control form-control-sm notes-input" 
                                                   id="notes_${student.id}"
                                                   placeholder="Примечание"
                                                   value="${student.notes || ''}"
                                                   onchange="updateAttendanceData(${student.id}, 'notes', this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        studentsList.innerHTML += studentHtml;
                        
                        // Сохраняем начальные данные
                        attendanceData[student.id] = {
                            status: student.status,
                            notes: student.notes || ''
                        };
                    });
                }
                
                // Показываем форму
                document.getElementById('attendanceContainer').style.display = 'block';
                window.scrollTo({ top: document.getElementById('attendanceContainer').offsetTop - 20, behavior: 'smooth' });
                
            } catch (error) {
                console.error('Ошибка загрузки студентов:', error);
                alert('Ошибка загрузки данных о студентах');
            }
        }

        // Генерация кнопок статуса
        function getStatusButtons(studentId, currentStatus) {
            const statuses = [
                {value: 'Присутствовал', label: 'Присутствовал', class: 'btn-success'},
                {value: 'Отсутствовал', label: 'Отсутствовал', class: 'btn-danger'},
                {value: 'По уважительной причине', label: 'Уважительная', class: 'btn-warning'},
                {value: 'Опоздал', label: 'Опоздал', class: 'btn-info'}
            ];
            
            return statuses.map(status => `
                <input type="radio" 
                       class="btn-check" 
                       name="status_${studentId}" 
                       id="status_${studentId}_${status.value}" 
                       value="${status.value}"
                       ${currentStatus === status.value ? 'checked' : ''}
                       onchange="updateAttendanceData(${studentId}, 'status', '${status.value}')">
                <label class="btn btn-outline-${status.class.split('-')[1]}" 
                       for="status_${studentId}_${status.value}">
                    ${status.label}
                </label>
            `).join('');
        }

        // Обновление данных посещаемости
        function updateAttendanceData(studentId, field, value) {
            if (!attendanceData[studentId]) {
                attendanceData[studentId] = {};
            }
            attendanceData[studentId][field] = value;
        }

        // Сброс формы
        function resetForm() {
            document.getElementById('attendanceContainer').style.display = 'none';
            currentClassData = null;
            attendanceData = {};
        }

        // Обработка отправки формы
        document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const scheduleId = document.getElementById('scheduleId').value;
            const teacherId = {{ session['user_id'] }};
            
            if (!currentClassData || Object.keys(attendanceData).length === 0) {
                alert('Нет данных для сохранения');
                return;
            }
            
            // Отправляем данные для каждого студента
            let savedCount = 0;
            let errorCount = 0;
            
            for (const studentId in attendanceData) {
                const data = attendanceData[studentId];
                
                const formData = new FormData();
                formData.append('schedule_id', scheduleId);
                formData.append('student_id', studentId);
                formData.append('status', data.status);
                formData.append('notes', data.notes || '');
                formData.append('marked_by', teacherId);
                
                try {
                    const response = await fetch('{{ url_for("mark_attendance") }}', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        savedCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Ошибка сохранения:', error);
                    errorCount++;
                }
            }
            
            // Показываем результат
            if (errorCount === 0) {
                alert(`Посещаемость успешно сохранена для ${savedCount} студентов`);
                resetForm();
                location.reload(); // Обновляем страницу
            } else {
                alert(`Сохранено: ${savedCount}, Ошибок: ${errorCount}`);
            }
        });

        // Инициализация страницы - автозагрузка первого занятия (опционально)
        document.addEventListener('DOMContentLoaded', function() {
            const firstClass = document.querySelector('.card .btn-light');
            if (firstClass) {
                // Можно автозагрузить первое занятие
                // firstClass.click();
            }
        });
    </script>
</body>
</html>