<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление группами дисциплины</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="icon" href="{{ url_for('static', filename='favic.ico') }}">
    <style>
    .btn-back-teacher {
        background-color: #198754;
        color: white;
        border: 2px solid #198754;
        font-weight: bold;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s;
    }
    .btn-back-teacher:hover {
        background-color: #157347;
        border-color: #146c43;
        transform: scale(1.05);
        color: white;
    }
    .card-header {
        background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    }
    .discipline-info {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .group-item {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
        transition: all 0.3s;
    }
    .group-item:hover {
        background-color: #f1f3f4;
        border-color: #198754;
    }
    .group-item.selected {
        background-color: #d4edda;
        border-color: #198754;
    }
    .semester-input {
        width: 100px;
        transition: all 0.3s;
    }
    .semester-input:focus {
        border-color: #20c997;
        box-shadow: 0 0 0 0.25rem rgba(32, 201, 151, 0.25);
    }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-success shadow">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-mortarboard"></i> Учёт посещаемости
            </a>
            <div class="navbar-nav ms-auto">
                <a href="{{ url_for('teacher_disciplines') }}" class="btn btn-back-teacher">
                    <i class="bi bi-arrow-left-circle"></i> Назад к дисциплинам
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header text-white">
                        <h4 class="mb-0"><i class="bi bi-people"></i> Управление группами для дисциплины</h4>
                    </div>
                    <div class="card-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                <div class="alert alert-{{ category if category != 'message' else 'info' }}">
                                    {{ message }}
                                </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}

                        <!-- Информация о дисциплине -->
                        <div class="discipline-info mb-4">
                            <h5>{{ discipline_name }}</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">Описание:</small>
                                    <div>{{ discipline_data[1] or 'Нет описания' }}</div>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Часов всего:</small>
                                    <div class="fw-bold">{{ discipline_data[2] }}</div>
                                </div>
                            </div>
                        </div>

                        <form method="POST">
                            <input type="hidden" name="discipline_id" value="{{ discipline_id }}">
                            
                            <div class="mb-4">
                                <label class="form-label fw-bold">Выберите группы для изучения дисциплины:</label>
                                <p class="text-muted">Отметьте группы, которые должны изучать эту дисциплину</p>
                                
                                <div class="border p-3 rounded" id="groupsContainer">
                                    {% if all_groups %}
                                        {% for group in all_groups %}
                                        {% set is_selected = group[0]|string in current_groups_dict %}
                                        <div class="group-item {% if is_selected %}selected{% endif %}">
                                            <div class="form-check">
                                                <input class="form-check-input group-checkbox" 
                                                       type="checkbox" 
                                                       name="groups" 
                                                       value="{{ group[0] }}" 
                                                       id="group{{ group[0] }}"
                                                       {% if is_selected %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="group{{ group[0] }}">
                                                    {{ group[1] }}
                                                </label>
                                            </div>
                                            
                                            <!-- Поле для семестра (отображается только если группа выбрана) -->
                                            <div class="mt-2 semester-field" 
                                                 style="display: {% if is_selected %}block{% else %}none{% endif %};">
                                                <small class="text-muted">Семестр:</small>
                                                <input type="number" 
                                                       class="form-control form-control-sm semester-input" 
                                                       name="semester_{{ group[0] }}" 
                                                       placeholder="Семестр (1-12)" 
                                                       min="1" max="12" 
                                                       value="{{ current_groups_dict.get(group[0]|string, '') }}"
                                                       data-group="{{ group[0] }}">
                                                <small class="text-muted">Укажите семестр изучения</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle"></i> Нет доступных групп
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-3 text-muted">
                                    <small><i class="bi bi-info-circle"></i> Для каждой выбранной группы укажите семестр (от 1 до 12)</small>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-save"></i> Сохранить изменения
                                </button>
                                <a href="{{ url_for('teacher_disciplines') }}" class="btn btn-secondary">Отмена</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.group-checkbox');
            const form = document.querySelector('form');
            
            // Обработка выбора группы
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const groupId = this.value;
                    const groupItem = this.closest('.group-item');
                    const semesterField = groupItem.querySelector('.semester-field');
                    const semesterInput = groupItem.querySelector('.semester-input');
                    
                    if (this.checked) {
                        groupItem.classList.add('selected');
                        semesterField.style.display = 'block';
                        semesterInput.required = true;
                    } else {
                        groupItem.classList.remove('selected');
                        semesterField.style.display = 'none';
                        semesterInput.required = false;
                        semesterInput.value = '';
                    }
                });
            });
            
            // Валидация формы
            form.addEventListener('submit', function(event) {
                let selectedGroups = [];
                let allSemestersValid = true;
                let errorMessages = [];
                
                // Собираем выбранные группы
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedGroups.push(checkbox.value);
                    }
                });
                
                // Проверка: выбрана ли хотя бы одна группа
                if (selectedGroups.length === 0) {
                    errorMessages.push('Необходимо выбрать хотя бы одну группу');
                }
                
                // Проверка семестров для выбранных групп
                selectedGroups.forEach(groupId => {
                    const semesterInput = document.querySelector(`.semester-input[data-group="${groupId}"]`);
                    const semesterValue = semesterInput.value.trim();
                    const groupName = document.querySelector(`label[for="group${groupId}"]`).textContent.trim();
                    
                    if (!semesterValue) {
                        errorMessages.push(`Для группы "${groupName}" не указан семестр`);
                        semesterInput.classList.add('is-invalid');
                        allSemestersValid = false;
                    } else if (parseInt(semesterValue) < 1 || parseInt(semesterValue) > 12) {
                        errorMessages.push(`Для группы "${groupName}" указан некорректный семестр (должен быть от 1 до 12)`);
                        semesterInput.classList.add('is-invalid');
                        allSemestersValid = false;
                    } else {
                        semesterInput.classList.remove('is-invalid');
                    }
                });
                
                // Если есть ошибки, предотвращаем отправку
                if (errorMessages.length > 0) {
                    event.preventDefault();
                    
                    // Показываем ошибки
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = `
                        <h5><i class="bi bi-exclamation-triangle"></i> Обнаружены ошибки:</h5>
                        <ul class="mb-0">
                            ${errorMessages.map(msg => `<li>${msg}</li>`).join('')}
                        </ul>
                    `;
                    
                    // Удаляем предыдущие сообщения об ошибках
                    const existingAlert = document.querySelector('.alert-danger');
                    if (existingAlert) {
                        existingAlert.remove();
                    }
                    
                    // Вставляем новое сообщение
                    form.parentNode.insertBefore(alertDiv, form);
                    
                    // Прокручиваем к ошибкам
                    alertDiv.scrollIntoView({ behavior: 'smooth' });
                    
                    return false;
                }
                
                return true;
            });
            
            // Валидация семестров при вводе
            const semesterInputs = document.querySelectorAll('.semester-input');
            semesterInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (value < 1 || value > 12) {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                    }
                });
            });
        });
    </script>
</body>
</html>